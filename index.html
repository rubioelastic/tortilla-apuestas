<!DOCTYPE html>
<html lang="es">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>TortillApuestas | La app de apuestas entre amigos</title>
   <script src="https://cdn.tailwindcss.com"></script>
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
   <style>
	   .tortilla-bg {
		   background-color: #fef3c7;
	   }
	   .tortilla-card {
		   background-color: #fef3c7;
		   border: 2px solid #f59e0b;
		   border-radius: 0.5rem;
	   }
	   .tortilla-button {
		   background-color: #f59e0b;
		   color: white;
		   transition: all 0.3s;
	   }
	   .tortilla-button:hover {
		   background-color: #d97706;
		   transform: scale(1.05);
	   }
	   .floating-tortilla {
		   animation: float 3s ease-in-out infinite;
	   }
	   @keyframes float {
		   0% { transform: translateY(0px); }
		   50% { transform: translateY(-10px); }
		   100% { transform: translateY(0px); }
	   }
	   .status-indicator {
		   position: fixed;
		   top: 10px;
		   right: 10px;
		   padding: 5px 10px;
		   border-radius: 15px;
		   font-size: 12px;
		   z-index: 1000;
	   }
	   .online { background-color: #10b981; color: white; }
	   .offline { background-color: #ef4444; color: white; }
	   .syncing { background-color: #f59e0b; color: white; }
   </style>
</head>
<body class="tortilla-bg min-h-screen">
   <!-- Indicador de estado -->
   <div id="status-indicator" class="status-indicator offline">
	   <i class="fas fa-wifi"></i> <span id="status-text">Sin conexi√≥n</span>
   </div>

   <div class="container mx-auto px-4 py-8 max-w-4xl">
	   <!-- Header -->
	   <header class="flex flex-col items-center mb-8">
		   <div class="floating-tortilla mb-4">
			   <img id="header-image" src="https://github.com/rubioelastic/tortilla-apuestas/raw/main/ConTortilla.png" alt="Ilustraci√≥n de una tortilla de patata espa√±ola jugosa con cebolla, vista desde arriba con estilo cartoon" class="rounded-full border-4 border-amber-500" style="width: 30mm; height: 30mm; object-fit: cover;">
		   </div>
		   <h1 class="text-4xl font-bold text-amber-800 mb-2">TortillApuestas</h1>
		   <p class="text-lg text-amber-700">¬°Donde las apuestas se pagan con tortilla!</p>
	   </header>
 
	   <!-- Main Content -->
	   <main>
		   <!-- Tabs Navigation -->
		   <div class="flex border-b border-amber-300 mb-6">
			   <button id="tab-activas" class="px-4 py-2 font-medium text-amber-800 border-b-2 border-amber-500 active-tab">Apuestas Activas</button>
			   <button id="tab-nueva" class="px-4 py-2 font-medium text-amber-600">Nueva Apuesta</button>
			   <button id="tab-historial" class="px-4 py-2 font-medium text-amber-600">Historial</button>
		   </div>
 
		   <!-- Apuestas Activas Tab -->
		   <div id="contenido-activas" class="tab-content">
			   <div class="flex justify-between items-center mb-4">
				   <h2 class="text-2xl font-semibold text-amber-800">Apuestas en juego</h2>
				   <span id="contador-apuestas" class="bg-amber-500 text-white px-3 py-1 rounded-full text-sm">0</span>
			   </div>
			   
			   <div id="lista-apuestas" class="grid gap-4 md:grid-cols-2">
				   <!-- Aqu√≠ se cargar√°n las apuestas din√°micamente -->
			   </div>
		   </div>
 
		   <!-- Nueva Apuesta Tab -->
		   <div id="contenido-nueva" class="tab-content hidden">
			   <h2 class="text-2xl font-semibold text-amber-800 mb-4">Crear nueva apuesta</h2>
			   <form id="form-nueva-apuesta" class="space-y-4">
				   <div>
					   <label for="titulo" class="block text-sm font-medium text-amber-700">T√≠tulo de la apuesta</label>
					   <input type="text" id="titulo" class="mt-1 block w-full rounded-md border-amber-300 shadow-sm focus:border-amber-500 focus:ring-amber-500" placeholder="Ej: ¬øQui√©n ganar√° la liga?" required>
				   </div>
				   
				   <div>
					   <label for="descripcion" class="block text-sm font-medium text-amber-700">Descripci√≥n</label>
					   <textarea id="descripcion" rows="2" class="mt-1 block w-full rounded-md border-amber-300 shadow-sm focus:border-amber-500 focus:ring-amber-500" placeholder="Detalles de la apuesta"></textarea>
				   </div>
				   
				   <div>
					   <label class="block text-sm font-medium text-amber-700">Participantes</label>
					   
					   <!-- A√±adir nuevo participante -->
					   <div class="mt-2 flex gap-2">
						   <input type="text" id="nuevo-participante" class="flex-1 rounded-md border-amber-300 shadow-sm focus:border-amber-500 focus:ring-amber-500" placeholder="Nombre del participante">
						   <button type="button" id="btn-a√±adir-participante" class="px-4 py-2 bg-amber-500 text-white rounded-md hover:bg-amber-600 transition-colors">
							   <i class="fas fa-plus"></i> A√±adir
						   </button>
					   </div>
					   
					   <!-- Lista de participantes -->
					   <div id="lista-participantes" class="mt-3 space-y-2">
						   <div class="flex items-center">
							   <input type="checkbox" id="participante1" value="Javi" class="h-4 w-4 rounded border-amber-300 text-amber-600 focus:ring-amber-500">
							   <label for="participante1" class="ml-2 block text-sm text-amber-700">Javi</label>
						   </div>
						   <div class="flex items-center">
							   <input type="checkbox" id="participante2" value="RaulG" class="h-4 w-4 rounded border-amber-300 text-amber-600 focus:ring-amber-500">
							   <label for="participante2" class="ml-2 block text-sm text-amber-700">RaulG</label>
						   </div>
						   <div class="flex items-center">
							   <input type="checkbox" id="participante3" value="Paula" class="h-4 w-4 rounded border-amber-300 text-amber-600 focus:ring-amber-500">
							   <label for="participante3" class="ml-2 block text-sm text-amber-700">Paula</label>
						   </div>
						   <div class="flex items-center">
							   <input type="checkbox" id="participante4" value="David" class="h-4 w-4 rounded border-amber-300 text-amber-600 focus:ring-amber-500">
							   <label for="participante4" class="ml-2 block text-sm text-amber-700">David</label>
						   </div>
					   </div>
				   </div>
				   
				   <div class="pt-4">
					   <button type="submit" class="w-full tortilla-button px-4 py-2 rounded-md font-medium flex items-center justify-center">
						   <i class="fas fa-plus-circle mr-2"></i> Crear Apuesta
					   </button>
				   </div>
			   </form>
		   </div>
 
		   <!-- Historial Tab -->
		   <div id="contenido-historial" class="tab-content hidden">
			   <h2 class="text-2xl font-semibold text-amber-800 mb-4">Historial de apuestas</h2>
			   
			   <div id="lista-historial" class="grid gap-4 md:grid-cols-2 mb-6">
				   <!-- Aqu√≠ se cargar√° el historial en formato tarjeta -->
			   </div>
			   
			   <div class="p-4 tortilla-card mt-4">
				   <h3 class="text-lg font-medium text-amber-800 mb-2">Estad√≠sticas</h3>
				   <div class="grid grid-cols-3 gap-4 text-center">
					   <div>
						   <p class="text-sm text-amber-600">Total apuestas</p>
						   <p id="total-apuestas" class="text-2xl font-bold text-amber-800">0</p>
					   </div>
					   <div>
						   <p class="text-sm text-amber-600">Tortillas pagadas</p>
						   <p id="tortillas-pagadas" class="text-2xl font-bold text-amber-800">0</p>
					   </div>
					   <div>
						   <p class="text-sm text-amber-600">Rey de la tortilla</p>
						   <p id="rey-tortilla" class="text-2xl font-bold text-amber-800">-</p>
					   </div>
				   </div>
			   </div>
		   </div>
	   </main>
   </div>
 
   <script>
	   // CONFIGURACI√ìN - URL DE GOOGLE APPS SCRIPT
	   const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwzYPZ0FUn_7pNRp6IBXE-hoTSSYLFsftIhJ2PbSEqxBqvKEGg3xXzw8SAYAF664gyFnqg/exec';
	   
	   // Variables globales
	   let apuestas = [];
	   let historial = [];
	   let isOnline = navigator.onLine;
	   let isSyncing = false;
	   let participanteCounter = 4; // Contador para IDs √∫nicos de participantes

	   // Funciones de conectividad
	   function updateConnectionStatus() {
		   const indicator = document.getElementById('status-indicator');
		   const statusText = document.getElementById('status-text');
		   
		   if (isSyncing) {
			   indicator.className = 'status-indicator syncing';
			   statusText.innerHTML = '<i class="fas fa-sync fa-spin"></i> Sincronizando...';
		   } else if (isOnline) {
			   indicator.className = 'status-indicator online';
			   statusText.innerHTML = '<i class="fas fa-cloud"></i> En l√≠nea';
		   } else {
			   indicator.className = 'status-indicator offline';
			   statusText.innerHTML = '<i class="fas fa-wifi"></i> Sin conexi√≥n';
		   }
	   }

	   // Detectar cambios de conectividad
	   window.addEventListener('online', () => {
		   isOnline = true;
		   updateConnectionStatus();
		   syncWithGoogleSheets();
	   });

	   window.addEventListener('offline', () => {
		   isOnline = false;
		   updateConnectionStatus();
	   });

	   // Funciones de Google Sheets
	   async function syncWithGoogleSheets() {
		   if (!isOnline || isSyncing || !GOOGLE_SCRIPT_URL) {
			   return;
		   }

		   isSyncing = true;
		   updateConnectionStatus();

		   try {
			   console.log('Sincronizando con Google Sheets...');
			   
			   // Cargar datos desde Google Sheets
			   const [apuestasResponse, historialResponse] = await Promise.all([
				   fetch(`${GOOGLE_SCRIPT_URL}?action=getApuestas`),
				   fetch(`${GOOGLE_SCRIPT_URL}?action=getHistorial`)
			   ]);

			   if (apuestasResponse.ok && historialResponse.ok) {
				   const apuestasData = await apuestasResponse.json();
				   const historialData = await historialResponse.json();

				   console.log('Datos recibidos de Google Sheets:', { apuestasData, historialData });

				   // Procesar datos de Google Sheets
				   apuestas = apuestasData.length > 0 ? apuestasData.map(item => ({
					   id: parseInt(item.id) || 0,
					   titulo: item.titulo || '',
					   descripcion: item.descripcion || '',
					   participantes: typeof item.participantes === 'string' ? 
						   item.participantes.split(', ').filter(p => p.trim()) : 
						   (Array.isArray(item.participantes) ? item.participantes : []),
					   fecha: item.fecha || '',
					   estado: item.estado || 'activa',
					   ganador: item.ganador || null,
					   resultado: item.resultado || '',
					   tortillas: parseInt(item.tortillas) || 0
				   })) : [];

				   historial = historialData.length > 0 ? historialData.map(item => ({
					   id: parseInt(item.id) || 0,
					   titulo: item.titulo || '',
					   descripcion: item.descripcion || '',
					   participantes: typeof item.participantes === 'string' ? 
						   item.participantes.split(', ').filter(p => p.trim()) : 
						   (Array.isArray(item.participantes) ? item.participantes : []),
					   fecha: item.fecha || '',
					   estado: 'finalizada',
					   ganador: item.ganador || '',
					   resultado: item.resultado || '',
					   tortillas: parseInt(item.tortillas) || 0
				   })) : [];
				   
				   // Actualizar interfaz
				   renderApuestasActivas();
				   renderHistorial();
				   updateEstadisticas();
			   } else {
				   console.log('Error en respuesta de Google Sheets:', apuestasResponse.status, historialResponse.status);
			   }
		   } catch (error) {
			   console.log('Error sincronizando con Google Sheets:', error);
		   }

		   isSyncing = false;
		   updateConnectionStatus();
	   }

	   async function saveToGoogleSheets(action, data) {
		   if (!isOnline || !GOOGLE_SCRIPT_URL) {
			   console.log('Sin conexi√≥n o URL no configurada');
			   return false;
		   }

		   try {
			   console.log(`üîÑ Enviando a Google Sheets - Action: ${action}`);
			   console.log(`üìä Data:`, data);
			   
			   const params = new URLSearchParams();
			   params.append('action', action);
			   params.append('data', JSON.stringify(data));

			   console.log(`üì§ Enviando POST a: ${GOOGLE_SCRIPT_URL}`);
			   console.log(`üìù Body:`, params.toString());

			   const response = await fetch(GOOGLE_SCRIPT_URL, {
				   method: 'POST',
				   headers: {
					   'Content-Type': 'application/x-www-form-urlencoded',
				   },
				   body: params.toString()
			   });

			   console.log(`üì• Response status: ${response.status}`);
			   console.log(`üì• Response ok: ${response.ok}`);
			   
			   const result = await response.text();
			   console.log(`üìÑ Response text:`, result);
			   
			   // Intentar parsear como JSON si es posible
			   try {
				   const jsonResult = JSON.parse(result);
				   console.log(`üìã Response JSON:`, jsonResult);
			   } catch (e) {
				   console.log(`üìã Response no es JSON v√°lido`);
			   }
			   
			   // Considerar exitoso si el status es 200-299, independientemente del contenido
			   if (response.status >= 200 && response.status < 300) {
				   console.log('‚úÖ Operaci√≥n completada exitosamente');
				   return true;
			   }
			   
			   console.error(`‚ùå Error HTTP: ${response.status} - ${result}`);
			   return false;
		   } catch (error) {
			   console.error('‚ùå Error de red guardando en Google Sheets:', error);
			   return false;
		   }
	   }

	   // DOM Elements
	   const tabActivas = document.getElementById('tab-activas');
	   const tabNueva = document.getElementById('tab-nueva');
	   const tabHistorial = document.getElementById('tab-historial');
	   const contenidoActivas = document.getElementById('contenido-activas');
	   const contenidoNueva = document.getElementById('contenido-nueva');
	   const contenidoHistorial = document.getElementById('contenido-historial');
	   const listaApuestas = document.getElementById('lista-apuestas');
	   const formNuevaApuesta = document.getElementById('form-nueva-apuesta');
	   const contadorApuestas = document.getElementById('contador-apuestas');
	   const totalApuestas = document.getElementById('total-apuestas');
	   const tortillasPagadas = document.getElementById('tortillas-pagadas');
	   const reyTortilla = document.getElementById('rey-tortilla');
	   const btnA√±adirParticipante = document.getElementById('btn-a√±adir-participante');
	   const inputNuevoParticipante = document.getElementById('nuevo-participante');
	   const listaParticipantes = document.getElementById('lista-participantes');
 
	   // Tab switching
	   tabActivas.addEventListener('click', () => {
		   contenidoActivas.classList.remove('hidden');
		   contenidoNueva.classList.add('hidden');
		   contenidoHistorial.classList.add('hidden');
		   document.getElementById('header-image').src = "https://github.com/rubioelastic/tortilla-apuestas/raw/main/ConTortilla.png";
		   updateActiveTab(tabActivas, tabNueva, tabHistorial);
		   renderApuestasActivas();
	   });
 
	   tabNueva.addEventListener('click', () => {
		   contenidoActivas.classList.add('hidden');
		   contenidoNueva.classList.remove('hidden');
		   contenidoHistorial.classList.add('hidden');
		   updateActiveTab(tabNueva, tabActivas, tabHistorial);
	   });
 
	   tabHistorial.addEventListener('click', () => {
		   contenidoActivas.classList.add('hidden');
		   contenidoNueva.classList.add('hidden');
		   contenidoHistorial.classList.remove('hidden');
		   updateActiveTab(tabHistorial, tabActivas, tabNueva);
		   document.getElementById('header-image').src = "https://github.com/rubioelastic/tortilla-apuestas/raw/main/SinTortilla.png";
		   renderHistorial();
		   updateEstadisticas();
	   });
 
	   function updateActiveTab(activeTab, ...otherTabs) {
		   activeTab.classList.remove('text-amber-600');
		   activeTab.classList.add('text-amber-800', 'border-amber-500');
		   otherTabs.forEach(tab => {
			   tab.classList.remove('text-amber-800', 'border-amber-500');
			   tab.classList.add('text-amber-600');
		   });
	   }
 
	   // Render apuestas activas
	   function renderApuestasActivas() {
		   listaApuestas.innerHTML = '';
		   const apuestasActivas = apuestas.filter(a => a.estado === 'activa' || a.estado === 'finalizada');
		   contadorApuestas.textContent = apuestasActivas.length;
		   
		   if (apuestasActivas.length === 0) {
			   listaApuestas.innerHTML = `
				   <div class="col-span-2 p-4 text-center tortilla-card">
					   <p class="text-amber-700">No hay apuestas activas. ¬°Crea una nueva!</p>
				   </div>
			   `;
			   return;
		   }
 
		   apuestasActivas.forEach(apuesta => {
			   const participantesHtml = apuesta.participantes.map(p => 
				   `<span class="inline-block bg-amber-100 rounded-full px-3 py-1 text-sm font-semibold text-amber-700 mr-2 mb-2">${p}</span>`
			   ).join('');
 
			   const card = document.createElement('div');
			   card.className = 'p-4 tortilla-card';
			   card.innerHTML = `
				   <div class="flex justify-between items-start">
					   <h3 class="text-lg font-bold text-amber-800">${apuesta.titulo}</h3>
					   <button class="text-white bg-amber-600 hover:bg-amber-700 px-3 py-1 rounded-md text-sm finalizar-btn" data-id="${apuesta.id}" title="Marcar ganador" ${apuesta.estado === 'finalizada' ? 'disabled' : ''}>
						   ${apuesta.estado === 'finalizada' ? '<i class="fas fa-check mr-1"></i>Finalizada' : '<i class="fas fa-trophy mr-1"></i>Finalizar'}
					   </button>
				   </div>
				   <p class="text-amber-700 mt-1">${apuesta.descripcion}</p>
				   <div class="mt-3">
					   ${participantesHtml}
				   </div>
				   <p class="text-sm text-amber-600 mt-2"><i class="far fa-calendar-alt mr-1"></i> ${apuesta.fecha}</p>
				   <div class="mt-3 border-t border-amber-200 pt-2">
					   <p class="text-xs font-semibold text-amber-600 uppercase">Estado</p>
					   ${apuesta.estado === 'finalizada' ? 
						   `<p class="text-sm text-amber-700">üèÜ Finalizada - <button onclick="marcarPagada(${apuesta.id})" class="text-amber-600 hover:text-amber-800 underline">Marcar como pagada</button></p>` :
						   `<p class="text-sm text-amber-700">‚è≥ Sin resultados</p>`}
				   </div>
			   `;
			   listaApuestas.appendChild(card);
		   });
 
		   // Add event listeners to finalizar buttons
		   document.querySelectorAll('.finalizar-btn').forEach(btn => {
			   btn.addEventListener('click', (e) => {
				   const id = parseInt(e.currentTarget.getAttribute('data-id'));
				   finalizarApuesta(id);
			   });
		   });
	   }
 
	   // Render historial
	   function renderHistorial() {
		   const listaHistorial = document.getElementById('lista-historial');
		   listaHistorial.innerHTML = '';
		   
		   if (historial.length === 0) {
			   listaHistorial.innerHTML = `
				   <div class="col-span-2 p-4 text-center tortilla-card">
					   <p class="text-amber-700">No hay apuestas en el historial</p>
				   </div>
			   `;
			   return;
		   }
 
		   historial.forEach(apuesta => {
			   const participantesHtml = apuesta.participantes.map(p => 
				   `<span class="inline-block bg-amber-100 rounded-full px-3 py-1 text-sm font-semibold text-amber-700 mr-2 mb-2">${p}</span>`
			   ).join('');
 
			   const card = document.createElement('div');
			   card.className = 'p-4 tortilla-card';
			   card.innerHTML = `
				   <div class="flex justify-between items-start">
					   <h3 class="text-lg font-bold text-amber-800">${apuesta.titulo}</h3>
				   </div>
				   <p class="text-amber-700 mt-1">${apuesta.descripcion}</p>
				   <div class="mt-3">
					   ${participantesHtml}
				   </div>
				   <p class="text-sm text-amber-600 mt-2"><i class="far fa-calendar-alt mr-1"></i> ${apuesta.fecha}</p>
				   <div class="mt-3 border-t border-amber-200 pt-2">
					   <p class="text-xs font-semibold text-amber-600 uppercase">Resultado</p>
					   <p class="text-sm font-medium text-green-600">üèÜ Ganador: ${apuesta.ganador}</p>
					   <p class="text-sm font-medium text-amber-700">ü•ö Tortillas: ${apuesta.tortillas}</p>
					   ${apuesta.resultado ? `<p class="text-sm font-medium text-gray-700">üìù Resultado: ${apuesta.resultado}</p>` : ''}
				   </div>
			   `;
			   listaHistorial.appendChild(card);
		   });
	   }
 
	   // Update estad√≠sticas
	   function updateEstadisticas() {
		   totalApuestas.textContent = historial.length;
		   
		   const totalTortillas = historial.reduce((total, apuesta) => total + (apuesta.tortillas || 0), 0);
		   tortillasPagadas.textContent = totalTortillas;
		   
		   // Calcular rey de la tortilla
		   const ganadores = {};
		   historial.forEach(apuesta => {
			   if (apuesta.ganador) {
				   ganadores[apuesta.ganador] = (ganadores[apuesta.ganador] || 0) + 1;
			   }
		   });
		   
		   let maxGanadas = 0;
		   let rey = '-';
		   for (const [nombre, count] of Object.entries(ganadores)) {
			   if (count > maxGanadas) {
				   maxGanadas = count;
				   rey = nombre;
			   }
		   }
		   
		   reyTortilla.textContent = rey !== '-' ? `${rey} (${maxGanadas})` : rey;
	   }
 
	   // Funci√≥n para a√±adir participante
	   function a√±adirParticipante() {
		   const nombre = inputNuevoParticipante.value.trim();
		   
		   if (!nombre) {
			   alert('Por favor, introduce un nombre para el participante');
			   return;
		   }
		   
		   // Verificar que no exista ya
		   const participantesExistentes = Array.from(document.querySelectorAll('#lista-participantes input[type="checkbox"]'))
			   .map(input => input.value.toLowerCase());
		   
		   if (participantesExistentes.includes(nombre.toLowerCase())) {
			   alert('Este participante ya existe en la lista');
			   return;
		   }
		   
		   // Crear nuevo checkbox
		   participanteCounter++;
		   const participanteId = `participante${participanteCounter}`;
		   
		   const participanteDiv = document.createElement('div');
		   participanteDiv.className = 'flex items-center justify-between';
		   participanteDiv.innerHTML = `
			   <div class="flex items-center">
				   <input type="checkbox" id="${participanteId}" value="${nombre}" class="h-4 w-4 rounded border-amber-300 text-amber-600 focus:ring-amber-500">
				   <label for="${participanteId}" class="ml-2 block text-sm text-amber-700">${nombre}</label>
			   </div>
			   <button type="button" class="text-red-500 hover:text-red-700 ml-2" onclick="eliminarParticipante(this)" title="Eliminar participante">
				   <i class="fas fa-times"></i>
			   </button>
		   `;
		   
		   listaParticipantes.appendChild(participanteDiv);
		   inputNuevoParticipante.value = '';
	   }
	   
	   // Funci√≥n para eliminar participante
	   function eliminarParticipante(button) {
		   const participanteDiv = button.closest('.flex');
		   const checkbox = participanteDiv.querySelector('input[type="checkbox"]');
		   
		   // No permitir eliminar participantes predeterminados
		   const participantesPredeterminados = ['Javi', 'RaulG', 'Paula', 'David'];
		   if (participantesPredeterminados.includes(checkbox.value)) {
			   alert('No puedes eliminar los participantes predeterminados');
			   return;
		   }
		   
		   if (confirm(`¬øEst√°s seguro de que quieres eliminar a ${checkbox.value}?`)) {
			   participanteDiv.remove();
		   }
	   }
	   
	   // Event listeners para participantes
	   btnA√±adirParticipante.addEventListener('click', a√±adirParticipante);
	   
	   inputNuevoParticipante.addEventListener('keypress', function(e) {
		   if (e.key === 'Enter') {
			   e.preventDefault();
			   a√±adirParticipante();
		   }
	   });

	   // Form handler - nueva apuesta
	   formNuevaApuesta.addEventListener('submit', async function(e) {
		   e.preventDefault();
		   
		   if (!isOnline) {
			   alert('‚ö†Ô∏è Sin conexi√≥n a internet. No se puede crear la apuesta.');
			   return;
		   }
		   
		   const titulo = document.getElementById('titulo').value;
		   const descripcion = document.getElementById('descripcion').value;
		   
		   const participantes = Array.from(document.querySelectorAll('#lista-participantes input[type="checkbox"]:checked'))
			   .map(el => el.value);
		   
		   if (participantes.length < 2) {
			   alert('¬°Necesitas al menos 2 participantes para una apuesta!');
			   return;
		   }
		   
		   const nuevaApuesta = {
			   id: apuestas.length > 0 ? Math.max(...apuestas.map(a => a.id), 0) + 1 : 1,
			   titulo,
			   descripcion,
			   participantes,
			   fecha: new Date().toISOString().split('T')[0],
			   estado: 'activa',
			   ganador: null,
			   resultado: "",
			   tortillas: 0
		   };
		   
		   // Guardar en Google Sheets
		   const success = await saveToGoogleSheets('addApuesta', nuevaApuesta);
		   if (success) {
			   // Recargar datos desde Google Sheets para mantener sincronizaci√≥n
			   await syncWithGoogleSheets();
			   
			   // Reset form
			   formNuevaApuesta.reset();
			   
			   // Switch to active bets tab and update
			   tabActivas.click();
			   
			   // Notificaci√≥n
			   alert('¬°Nueva apuesta creada! üéâ');
		   } else {
			   alert('‚ùå Error al crear la apuesta. Int√©ntalo de nuevo.');
		   }
	   });
 
	   // Marcar como pagada
	   async function marcarPagada(id) {
		   if (!isOnline) {
			   alert('‚ö†Ô∏è Sin conexi√≥n a internet. No se puede marcar como pagada.');
			   return;
		   }
		   
		   const apuesta = apuestas.find(a => a.id === id);
		   if (!apuesta) return;
		   
		   if (confirm(`¬øConfirmas que la apuesta "${apuesta.titulo}" ha sido pagada?`)) {
			   // Eliminar de Google Sheets
			   const success = await saveToGoogleSheets('deleteApuesta', { id });
			   if (success) {
				   // Recargar datos desde Google Sheets
				   await syncWithGoogleSheets();
			   } else {
				   alert('‚ùå Error al marcar como pagada. Int√©ntalo de nuevo.');
			   }
		   }
	   }
 
	   // Finalizar apuesta
	   async function finalizarApuesta(id) {
		   if (!isOnline) {
			   alert('‚ö†Ô∏è Sin conexi√≥n a internet. No se puede finalizar la apuesta.');
			   return;
		   }
		   
		   const apuesta = apuestas.find(a => a.id === id);
		   if (!apuesta) return;
		   
		   const ganador = prompt(`Introduce el ganador de "${apuesta.titulo}":`, apuesta.participantes[0]);
		   if (!ganador || !apuesta.participantes.includes(ganador)) {
			   alert('Por favor, introduce un participante v√°lido');
			   return;
		   }
		   
		   const resultado = prompt(`Introduce el resultado de "${apuesta.titulo}":`, "Detalles del resultado");
		   const tortillas = parseInt(prompt('¬øCu√°ntas tortillas se deben?', '1')) || 1;
		   
		   // Actualizar apuesta
		   apuesta.estado = 'finalizada';
		   apuesta.ganador = ganador;
		   apuesta.tortillas = tortillas;
		   apuesta.resultado = resultado || "";
		   
		   // Guardar cambios en Google Sheets
		   const success1 = await saveToGoogleSheets('updateApuesta', apuesta);
		   const success2 = await saveToGoogleSheets('moveToHistorial', apuesta);
		   
		   if (success1 && success2) {
			   // Recargar datos desde Google Sheets
			   await syncWithGoogleSheets();
			   
			   // Notificaci√≥n mejorada
			   const mensaje = `${ganador} gan√≥ '${apuesta.titulo}'!\n\nüèÜ Premio: ${tortillas} tortilla(s)!\nüìÖ Fecha tope: ${new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toLocaleDateString()}\nüìç Lugar: Quedada en casa del perdedor`;
			   
			   // Notificar a todos los participantes
			   apuesta.participantes.forEach(participante => {
				   const esGanador = participante === ganador;
				   const mensajeIndividual = esGanador 
					   ? `üéâ ${mensaje}\n\n¬°Disfruta tu premio!` 
					   : `üòÖ ${mensaje}\n\n¬°A pagar la apuesta!`;
					   
				   console.log(`Notificaci√≥n para ${participante}: ${mensajeIndividual}`);
			   });
			   
			   alert(mensaje);
		   } else {
			   alert('‚ùå Error al finalizar la apuesta. Int√©ntalo de nuevo.');
		   }
	   }
 
	   // Initialize
	   document.addEventListener('DOMContentLoaded', () => {
		   updateConnectionStatus();
		   
		   // Cargar datos desde Google Sheets
		   if (isOnline) {
			   syncWithGoogleSheets();
		   } else {
			   // Si no hay conexi√≥n, mostrar mensaje
			   document.getElementById('lista-apuestas').innerHTML = `
				   <div class="col-span-2 p-4 text-center tortilla-card">
					   <p class="text-amber-700">‚ö†Ô∏è Sin conexi√≥n a internet. La aplicaci√≥n requiere conexi√≥n para funcionar.</p>
				   </div>
			   `;
		   }
		   
		   // Sincronizar cada 30 segundos si hay conexi√≥n
		   setInterval(() => {
			   if (isOnline && !isSyncing) {
				   syncWithGoogleSheets();
			   }
		   }, 30000);
		   
		   // Simular notificaci√≥n push (en una app real usar√≠as la API de notificaciones)
		   setTimeout(() => {
			   if (historial.length > 0) {
				   console.log('[Notificaci√≥n] Recordatorio: Hay tortillas pendientes de pagar');
			   }
		   }, 3000);
	   });
