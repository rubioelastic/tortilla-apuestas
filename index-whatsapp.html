<!DOCTYPE html>
<html lang="es">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>TortillApuestas | La app de apuestas entre amigos</title>
   <script src="https://cdn.tailwindcss.com"></script>
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
   
   <!-- Firebase SDK -->
   <script type="module">
     import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
     import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
     
     // Configuración de Firebase REAL (ya configurado)
     const firebaseConfig = {
       apiKey: "AIzaSyAAKPn-I5ypYOxDzFfD5nWQ87n3_WJJ4TA",
       authDomain: "tortilla-apuestas.firebaseapp.com",
       projectId: "tortilla-apuestas",
       storageBucket: "tortilla-apuestas.firebasestorage.app",
       messagingSenderId: "790007868199",
       appId: "1:790007868199:web:02e490a886dc37554a1702"
     };
     
     // Inicializar Firebase
     const app = initializeApp(firebaseConfig);
     const db = getFirestore(app);
     
     // Hacer disponible globalmente
     window.db = db;
     window.firestore = { collection, addDoc, getDocs, updateDoc, deleteDoc, doc, onSnapshot };
     window.isFirebaseReal = true; // Marcar que Firebase está configurado
   </script>
   
   <style>
	   .tortilla-bg {
		   background-color: #fef3c7;
	   }
	   .tortilla-card {
		   background-color: #fef3c7;
		   border: 2px solid #f59e0b;
		   border-radius: 0.5rem;
	   }
	   .tortilla-button {
		   background-color: #f59e0b;
		   color: white;
		   transition: all 0.3s;
	   }
	   .tortilla-button:hover {
		   background-color: #d97706;
		   transform: scale(1.05);
	   }
	   .floating-tortilla {
		   animation: float 3s ease-in-out infinite;
	   }
	   @keyframes float {
		   0% { transform: translateY(0px); }
		   50% { transform: translateY(-10px); }
		   100% { transform: translateY(0px); }
	   }
	   .status-indicator {
		   position: fixed;
		   top: 10px;
		   right: 10px;
		   padding: 5px 10px;
		   border-radius: 15px;
		   font-size: 12px;
		   z-index: 1000;
	   }
	   .cloud { background-color: #10b981; color: white; }
	   .offline { background-color: #ef4444; color: white; }
	   .syncing { background-color: #f59e0b; color: white; }
	   .whatsapp-config {
		   position: fixed;
		   bottom: 20px;
		   right: 20px;
		   z-index: 1000;
	   }
	   .whatsapp-modal {
		   position: fixed;
		   top: 0;
		   left: 0;
		   width: 100%;
		   height: 100%;
		   background: rgba(0,0,0,0.5);
		   z-index: 2000;
		   display: none;
	   }
   </style>
</head>
<body class="tortilla-bg min-h-screen">
   <!-- Indicador de estado -->
   <div id="status-indicator" class="status-indicator cloud">
	   <i class="fas fa-cloud"></i> <span id="status-text">Sincronizado</span>
   </div>

   <!-- Botón configuración WhatsApp -->
   <div class="whatsapp-config">
	   <button id="btn-whatsapp-config" class="bg-green-500 hover:bg-green-600 text-white p-3 rounded-full shadow-lg transition-all" title="Configurar notificaciones WhatsApp">
		   <i class="fab fa-whatsapp text-xl"></i>
	   </button>
   </div>

   <!-- Modal configuración WhatsApp -->
   <div id="whatsapp-modal" class="whatsapp-modal">
	   <div class="flex items-center justify-center h-full">
		   <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
			   <div class="flex justify-between items-center mb-4">
				   <h3 class="text-lg font-bold text-gray-800">
					   <i class="fab fa-whatsapp text-green-500 mr-2"></i>
					   Configurar WhatsApp
				   </h3>
				   <button id="close-whatsapp-modal" class="text-gray-500 hover:text-gray-700">
					   <i class="fas fa-times"></i>
				   </button>
			   </div>
			   
			   <div class="mb-6">
				   <label class="flex items-center">
					   <input type="checkbox" id="whatsapp-enabled" class="mr-2">
					   <span class="text-sm font-medium">Activar notificaciones WhatsApp</span>
				   </label>
				   <p class="text-xs text-gray-500 mt-1">Las notificaciones se enviarán automáticamente cuando se creen o finalicen apuestas</p>
			   </div>

			   <!-- Tabs para gestión -->
			   <div class="mb-4">
				   <div class="flex border-b">
					   <button id="tab-quick-numbers" class="px-4 py-2 text-sm font-medium text-green-600 border-b-2 border-green-500">Números Rápidos</button>
					   <button id="tab-participants" class="px-4 py-2 text-sm font-medium text-gray-500">Gestionar Participantes</button>
				   </div>
			   </div>

			   <!-- Tab: Números Rápidos -->
			   <div id="content-quick-numbers" class="tab-content-modal">
				   <div class="mb-4">
					   <label class="block text-sm font-medium text-gray-700 mb-2">
						   Números de teléfono (formato: +34XXXXXXXXX)
					   </label>
					   <div id="phone-numbers-list" class="space-y-2 mb-3 max-h-40 overflow-y-auto">
						   <!-- Se llenarán dinámicamente -->
					   </div>
					   <div class="flex">
						   <input type="text" id="new-phone-number" placeholder="+34123456789" class="flex-1 border rounded-l px-3 py-2 text-sm">
						   <button id="add-phone-number" class="bg-green-500 text-white px-3 py-2 rounded-r hover:bg-green-600">
							   <i class="fas fa-plus"></i>
						   </button>
					   </div>
					   <p class="text-xs text-gray-500 mt-1">Añade números directamente para notificaciones rápidas</p>
				   </div>
			   </div>

			   <!-- Tab: Gestionar Participantes -->
			   <div id="content-participants" class="tab-content-modal hidden">
				   <div class="mb-4">
					   <label class="block text-sm font-medium text-gray-700 mb-2">
						   Participantes con números de teléfono
					   </label>
					   <div id="participants-list" class="space-y-2 mb-3 max-h-40 overflow-y-auto">
						   <!-- Se llenarán dinámicamente -->
					   </div>
					   <div class="space-y-2">
						   <input type="text" id="new-participant-name" placeholder="Nombre del participante" class="w-full border rounded px-3 py-2 text-sm">
						   <input type="text" id="new-participant-phone" placeholder="+34123456789 (opcional)" class="w-full border rounded px-3 py-2 text-sm">
					   </div>
					   <button id="add-participant" class="mt-2 w-full bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 text-sm">
						   <i class="fas fa-user-plus mr-1"></i> Añadir Participante
					   </button>
					   <p class="text-xs text-gray-500 mt-1">El número de teléfono es opcional y privado. Solo tú podrás verlo para enviar notificaciones.</p>
				   </div>
			   </div>
			   
			   <div class="flex justify-between items-center pt-4 border-t">
				   <div class="flex items-center space-x-4">
					   <div class="text-xs text-gray-500">
						   <i class="fas fa-cloud mr-1"></i>
						   Sincronizado con Firebase
					   </div>
					   <button id="change-pin-btn" class="text-xs text-blue-600 hover:text-blue-800 underline" title="Cambiar PIN de administrador">
						   <i class="fas fa-key mr-1"></i> Cambiar PIN
					   </button>
				   </div>
				   <div class="flex space-x-2">
					   <button id="cancel-whatsapp-config" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancelar</button>
					   <button id="save-whatsapp-config" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
						   <i class="fas fa-save mr-1"></i> Guardar
					   </button>
				   </div>
			   </div>
		   </div>
	   </div>
   </div>

   <div class="container mx-auto px-4 py-8 max-w-4xl">
	   <!-- Header -->
	   <header class="flex flex-col items-center mb-8">
		   <div class="floating-tortilla mb-4">
			   <img id="header-image" src="ConTortilla.png" alt="Ilustración de una tortilla de patata española jugosa con cebolla, vista desde arriba con estilo cartoon" class="rounded-full border-4 border-amber-500" style="width: 60mm; height: 60mm; object-fit: cover;">
		   </div>
		   <h1 class="text-4xl font-bold text-amber-800 mb-2">TortillApuestas</h1>
		   <p class="text-lg text-amber-700">¡Donde las apuestas se pagan con tortilla!</p>
	   </header>
 
	   <!-- Main Content -->
	   <main>
		   <!-- Tabs Navigation -->
		   <div class="flex border-b border-amber-300 mb-6">
			   <button id="tab-activas" class="px-4 py-2 font-medium text-amber-800 border-b-2 border-amber-500 active-tab">Apuestas Activas</button>
			   <button id="tab-nueva" class="px-4 py-2 font-medium text-amber-600">Nueva Apuesta</button>
			   <button id="tab-historial" class="px-4 py-2 font-medium text-amber-600">Historial</button>
		   </div>
 
		   <!-- Apuestas Activas Tab -->
		   <div id="contenido-activas" class="tab-content">
			   <div class="flex justify-between items-center mb-4">
				   <h2 class="text-2xl font-semibold text-amber-800">Apuestas en juego</h2>
				   <span id="contador-apuestas" class="bg-amber-500 text-white px-3 py-1 rounded-full text-sm">0</span>
			   </div>
			   
			   <div id="lista-apuestas" class="grid gap-4 md:grid-cols-2">
				   <!-- Aquí se cargarán las apuestas dinámicamente -->
			   </div>
		   </div>
 
		   <!-- Nueva Apuesta Tab -->
		   <div id="contenido-nueva" class="tab-content hidden">
			   <h2 class="text-2xl font-semibold text-amber-800 mb-4">Crear nueva apuesta</h2>
			   <form id="form-nueva-apuesta" class="space-y-4">
				   <div>
					   <label for="titulo" class="block text-sm font-medium text-amber-700">Título de la apuesta</label>
					   <input type="text" id="titulo" class="mt-1 block w-full rounded-md border-amber-300 shadow-sm focus:border-amber-500 focus:ring-amber-500" placeholder="Ej: ¿Quién ganará la liga?" required>
				   </div>
				   
				   <div>
					   <label for="descripcion" class="block text-sm font-medium text-amber-700">Descripción</label>
					   <textarea id="descripcion" rows="2" class="mt-1 block w-full rounded-md border-amber-300 shadow-sm focus:border-amber-500 focus:ring-amber-500" placeholder="Detalles de la apuesta"></textarea>
				   </div>
				   
				   <div>
					   <label class="block text-sm font-medium text-amber-700">Participantes</label>
					   <p class="text-xs text-amber-600 mt-1">Selecciona los participantes para esta apuesta. Gestiona participantes desde el botón de WhatsApp.</p>
					   
					   <!-- Lista de participantes desde Firebase -->
					   <div id="lista-participantes" class="mt-3 space-y-2">
						   <!-- Se cargarán dinámicamente desde Firebase -->
					   </div>
					   
					   <div class="mt-2 p-2 bg-amber-50 rounded-md text-xs text-amber-700">
						   <i class="fas fa-info-circle mr-1"></i>
						   ¿No ves a alguien? Añádelo desde <strong>Configurar WhatsApp → Gestionar Participantes</strong>
					   </div>
				   </div>
				   
				   <div class="pt-4">
					   <button type="submit" class="w-full tortilla-button px-4 py-2 rounded-md font-medium flex items-center justify-center">
						   <i class="fas fa-plus-circle mr-2"></i> Crear Apuesta
					   </button>
				   </div>
			   </form>
		   </div>
 
		   <!-- Historial Tab -->
		   <div id="contenido-historial" class="tab-content hidden">
			   <h2 class="text-2xl font-semibold text-amber-800 mb-4">Historial de apuestas</h2>
			   
			   <div id="lista-historial" class="grid gap-4 md:grid-cols-2 mb-6">
				   <!-- Aquí se cargará el historial en formato tarjeta -->
			   </div>
			   
			   <div class="p-4 tortilla-card mt-4">
				   <h3 class="text-lg font-medium text-amber-800 mb-2">Estadísticas</h3>
				   <div class="grid grid-cols-3 gap-4 text-center">
					   <div>
						   <p class="text-sm text-amber-600">Total apuestas</p>
						   <p id="total-apuestas" class="text-2xl font-bold text-amber-800">0</p>
					   </div>
					   <div>
						   <p class="text-sm text-amber-600">Tortillas pagadas</p>
						   <p id="tortillas-pagadas" class="text-2xl font-bold text-amber-800">0</p>
					   </div>
					   <div>
						   <p class="text-sm text-amber-600">Rey de la tortilla</p>
						   <p id="rey-tortilla" class="text-2xl font-bold text-amber-800">-</p>
					   </div>
				   </div>
			   </div>
		   </div>
	   </main>
   </div>
 
   <script>
	   // Variables globales
	   let apuestas = [];
	   let historial = [];
	   let participanteCounter = 4;
	   let isConnected = true; // Firebase está configurado

	   // Configuración WhatsApp
	   let whatsappConfig = {
		   enabled: false,
		   phoneNumbers: [],
		   notifyNewBet: true,
		   notifyFinishedBet: true,
		   adminPin: null // PIN de administrador
	   };

	   // Cargar configuración WhatsApp desde Firebase
	   async function loadWhatsAppConfig() {
		   try {
			   console.log('Cargando configuración WhatsApp desde Firebase...');
			   const configSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'whatsapp-config'));
			   
			   if (!configSnapshot.empty) {
				   const configDoc = configSnapshot.docs[0];
				   const savedConfig = configDoc.data();
				   whatsappConfig = { ...whatsappConfig, ...savedConfig, id: configDoc.id };
				   console.log('Configuración WhatsApp cargada:', whatsappConfig);
			   } else {
				   console.log('No hay configuración WhatsApp guardada, usando valores por defecto');
			   }
		   } catch (error) {
			   console.error('Error cargando configuración WhatsApp:', error);
			   // Fallback a localStorage si Firebase falla
			   const saved = localStorage.getItem('whatsappConfig');
			   if (saved) {
				   whatsappConfig = { ...whatsappConfig, ...JSON.parse(saved) };
			   }
		   }
		   updateWhatsAppUI();
	   }

	   // Guardar configuración WhatsApp en Firebase
	   async function saveWhatsAppConfig() {
		   try {
			   const configToSave = {
				   enabled: whatsappConfig.enabled,
				   phoneNumbers: whatsappConfig.phoneNumbers,
				   notifyNewBet: whatsappConfig.notifyNewBet,
				   notifyFinishedBet: whatsappConfig.notifyFinishedBet,
				   lastUpdated: new Date().toISOString()
			   };

			   if (whatsappConfig.id) {
				   // Actualizar configuración existente
				   await window.firestore.updateDoc(window.firestore.doc(window.db, 'whatsapp-config', whatsappConfig.id), configToSave);
				   console.log('Configuración WhatsApp actualizada en Firebase');
			   } else {
				   // Crear nueva configuración
				   const docRef = await window.firestore.addDoc(window.firestore.collection(window.db, 'whatsapp-config'), configToSave);
				   whatsappConfig.id = docRef.id;
				   console.log('Configuración WhatsApp guardada en Firebase con ID:', docRef.id);
			   }

			   // Backup en localStorage
			   localStorage.setItem('whatsappConfig', JSON.stringify(whatsappConfig));
			   return true;
		   } catch (error) {
			   console.error('Error guardando configuración WhatsApp:', error);
			   // Fallback a localStorage
			   localStorage.setItem('whatsappConfig', JSON.stringify(whatsappConfig));
			   return false;
		   }
	   }

	   // Cargar usuarios/participantes desde Firebase
	   async function loadParticipants() {
		   try {
			   console.log('Cargando participantes desde Firebase...');
			   const participantsSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'participants'));
			   
			   const participants = [];
			   participantsSnapshot.forEach((doc) => {
				   participants.push({ id: doc.id, ...doc.data() });
			   });
			   
			   console.log('Participantes cargados:', participants);
			   return participants;
		   } catch (error) {
			   console.error('Error cargando participantes:', error);
			   return [];
		   }
	   }

	   // Guardar/actualizar participante en Firebase
	   async function saveParticipant(name, phoneNumber = '') {
		   try {
			   const participantData = {
				   name: name,
				   phoneNumber: phoneNumber,
				   createdAt: new Date().toISOString()
			   };

			   await window.firestore.addDoc(window.firestore.collection(window.db, 'participants'), participantData);
			   console.log('Participante guardado:', participantData);
			   return true;
		   } catch (error) {
			   console.error('Error guardando participante:', error);
			   return false;
		   }
	   }

	   // Actualizar UI de WhatsApp
	   function updateWhatsAppUI() {
		   const btnConfig = document.getElementById('btn-whatsapp-config');
		   if (whatsappConfig.enabled && whatsappConfig.phoneNumbers.length > 0) {
			   btnConfig.classList.remove('bg-gray-400');
			   btnConfig.classList.add('bg-green-500', 'hover:bg-green-600');
			   btnConfig.title = `WhatsApp activo (${whatsappConfig.phoneNumbers.length} números)`;
		   } else {
			   btnConfig.classList.remove('bg-green-500', 'hover:bg-green-600');
			   btnConfig.classList.add('bg-gray-400');
			   btnConfig.title = 'Configurar WhatsApp';
		   }
	   }

	   // Funciones WhatsApp
	   function sendWhatsAppNotification(message) {
		   if (!whatsappConfig.enabled || whatsappConfig.phoneNumbers.length === 0) {
			   console.log('WhatsApp notifications disabled or no numbers configured');
			   return;
		   }

		   // Mostrar confirmación antes de enviar
		   const shouldSend = confirm(`¿Enviar notificación WhatsApp a ${whatsappConfig.phoneNumbers.length} contacto(s)?`);
		   if (!shouldSend) return;

		   whatsappConfig.phoneNumbers.forEach((number, index) => {
			   setTimeout(() => {
				   const encodedMessage = encodeURIComponent(message);
				   const whatsappUrl = `https://wa.me/${number.replace(/[^0-9]/g, '')}?text=${encodedMessage}`;
				   window.open(whatsappUrl, '_blank');
			   }, index * 1000); // Delay de 1 segundo entre cada mensaje
		   });
	   }

	   function notifyNewBet(apuesta) {
		   if (!whatsappConfig.notifyNewBet) return;

		   const participantesText = apuesta.participantes.join(', ');
		   const message = `🥚 *NUEVA APUESTA EN TORTILLAPUESTAS* 🥚

📋 *Título:* ${apuesta.titulo}
📝 *Descripción:* ${apuesta.descripcion}
👥 *Participantes:* ${participantesText}
📅 *Fecha:* ${apuesta.fecha}

¡Entra en la app para ver los detalles!
${window.location.href}`;

		   sendWhatsAppNotification(message);
	   }

	   function notifyFinishedBet(apuesta) {
		   if (!whatsappConfig.notifyFinishedBet) return;

		   const message = `🏆 *APUESTA FINALIZADA* 🏆

📋 *Apuesta:* ${apuesta.titulo}
🎉 *Ganador:* ${apuesta.ganador}
🥚 *Tortillas a pagar:* ${apuesta.tortillas}
📝 *Resultado:* ${apuesta.resultado}

¡${apuesta.ganador} ha ganado! 🎊
${window.location.href}`;

		   sendWhatsAppNotification(message);
	   }

	   // Funciones Firebase para guardar/cargar datos
	   async function cargarDatosFirebase() {
		   try {
			   console.log('Cargando datos desde Firebase...');
			   
			   // Cargar apuestas
			   const apuestasSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'apuestas'));
			   apuestas = [];
			   apuestasSnapshot.forEach((doc) => {
				   apuestas.push({ id: doc.id, ...doc.data() });
			   });
			   
			   // Cargar historial
			   const historialSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'historial'));
			   historial = [];
			   historialSnapshot.forEach((doc) => {
				   historial.push({ id: doc.id, ...doc.data() });
			   });
			   
			   console.log('Datos cargados:', { apuestas: apuestas.length, historial: historial.length });
			   
			   // Si no hay datos, cargar datos de ejemplo
			   if (apuestas.length === 0 && historial.length === 0) {
				   await cargarDatosEjemplo();
			   }
			   
		   } catch (error) {
			   console.error('Error cargando datos de Firebase:', error);
			   // Cargar datos de ejemplo si hay error
			   loadDemoDataLocal();
		   }
		   
		   renderApuestasActivas();
		   renderHistorial();
		   updateEstadisticas();
	   }

	   async function cargarDatosEjemplo() {
		   console.log('Cargando datos de ejemplo en Firebase...');
		   
		   const apuestaEjemplo = {
			   titulo: "¿Lloverá el fin de semana?",
			   descripcion: "Apostamos a que no lloverá durante el finde en Madrid",
			   participantes: ["Javi", "RaulG", "Paula"],
			   fecha: "2024-12-15",
			   estado: "activa",
			   ganador: null,
			   resultado: ""
		   };
		   
		   const historialEjemplo = {
			   titulo: "Quién llega tarde",
			   descripcion: "Javi llegará más de 15 minutos tarde a la cena",
			   participantes: ["Javi", "RaulG", "Paula", "David"],
			   fecha: "2024-12-01",
			   estado: "finalizada",
			   ganador: "RaulG",
			   tortillas: 1,
			   resultado: "Javi llegó 20 minutos tarde"
		   };
		   
		   try {
			   await window.firestore.addDoc(window.firestore.collection(window.db, 'apuestas'), apuestaEjemplo);
			   await window.firestore.addDoc(window.firestore.collection(window.db, 'historial'), historialEjemplo);
			   console.log('Datos de ejemplo guardados en Firebase');
			   
			   // Recargar datos
			   await cargarDatosFirebase();
		   } catch (error) {
			   console.error('Error guardando datos de ejemplo:', error);
		   }
	   }

	   // Datos locales como fallback
	   function loadDemoDataLocal() {
		   apuestas = [
			   {
				   id: 1,
				   titulo: "¿Lloverá el fin de semana?",
				   descripcion: "Apostamos a que no lloverá durante el finde en Madrid",
				   participantes: ["Javi", "RaulG", "Paula"],
				   fecha: "2024-12-15",
				   estado: "activa",
				   ganador: null,
				   resultado: ""
			   }
		   ];
		   
		   historial = [
			   {
				   id: 2,
				   titulo: "Quién llega tarde",
				   descripcion: "Javi llegará más de 15 minutos tarde a la cena",
				   participantes: ["Javi", "RaulG", "Paula", "David"],
				   fecha: "2024-12-01",
				   estado: "finalizada",
				   ganador: "RaulG",
				   tortillas: 1,
				   resultado: "Javi llegó 20 minutos tarde"
			   }
		   ];
	   }

	   // Guardar apuesta en Firebase
	   async function guardarApuestaFirebase(apuesta) {
		   try {
			   await window.firestore.addDoc(window.firestore.collection(window.db, 'apuestas'), apuesta);
			   console.log('Apuesta guardada en Firebase');
			   return true;
		   } catch (error) {
			   console.error('Error guardando apuesta:', error);
			   return false;
		   }
	   }

	   // Actualizar apuesta en Firebase
	   async function actualizarApuestaFirebase(id, datos) {
		   try {
			   await window.firestore.updateDoc(window.firestore.doc(window.db, 'apuestas', id), datos);
			   console.log('Apuesta actualizada en Firebase');
			   return true;
		   } catch (error) {
			   console.error('Error actualizando apuesta:', error);
			   return false;
		   }
	   }

	   // Eliminar apuesta de Firebase
	   async function eliminarApuestaFirebase(id) {
		   try {
			   await window.firestore.deleteDoc(window.firestore.doc(window.db, 'apuestas', id));
			   console.log('Apuesta eliminada de Firebase');
			   return true;
		   } catch (error) {
			   console.error('Error eliminando apuesta:', error);
			   return false;
		   }
	   }

	   // Guardar en historial Firebase
	   async function guardarHistorialFirebase(apuesta) {
		   try {
			   await window.firestore.addDoc(window.firestore.collection(window.db, 'historial'), apuesta);
			   console.log('Historial guardado en Firebase');
			   return true;
		   } catch (error) {
			   console.error('Error guardando historial:', error);
			   return false;
		   }
	   }

	   // DOM Elements
	   const tabActivas = document.getElementById('tab-activas');
	   const tabNueva = document.getElementById('tab-nueva');
	   const tabHistorial = document.getElementById('tab-historial');
	   const contenidoActivas = document.getElementById('contenido-activas');
	   const contenidoNueva = document.getElementById('contenido-nueva');
	   const contenidoHistorial = document.getElementById('contenido-historial');
	   const listaApuestas = document.getElementById('lista-apuestas');
	   const formNuevaApuesta = document.getElementById('form-nueva-apuesta');
	   const contadorApuestas = document.getElementById('contador-apuestas');
	   const totalApuestas = document.getElementById('total-apuestas');
	   const tortillasPagadas = document.getElementById('tortillas-pagadas');
	   const reyTortilla = document.getElementById('rey-tortilla');
	   const listaParticipantes = document.getElementById('lista-participantes');
 
	   // Tab switching
	   function initializeTabs() {
		   console.log('Inicializando pestañas...');
		   
		   if (tabActivas) {
			   tabActivas.addEventListener('click', () => {
				   console.log('Click en Apuestas Activas');
				   contenidoActivas.classList.remove('hidden');
				   contenidoNueva.classList.add('hidden');
				   contenidoHistorial.classList.add('hidden');
				   document.getElementById('header-image').src = "ConTortilla.png";
				   updateActiveTab(tabActivas, tabNueva, tabHistorial);
				   renderApuestasActivas();
			   });
		   }
 
		   if (tabNueva) {
			   tabNueva.addEventListener('click', async () => {
				   console.log('Click en Nueva Apuesta');
				   contenidoActivas.classList.add('hidden');
				   contenidoNueva.classList.remove('hidden');
				   contenidoHistorial.classList.add('hidden');
				   updateActiveTab(tabNueva, tabActivas, tabHistorial);
				   // Recargar participantes cuando se cambie a esta pestaña
				   await renderParticipantesFormulario();
			   });
		   }
 
		   if (tabHistorial) {
			   tabHistorial.addEventListener('click', () => {
				   console.log('Click en Historial');
				   contenidoActivas.classList.add('hidden');
				   contenidoNueva.classList.add('hidden');
				   contenidoHistorial.classList.remove('hidden');
				   updateActiveTab(tabHistorial, tabActivas, tabNueva);
				   document.getElementById('header-image').src = "SinTortilla.png";
				   renderHistorial();
				   updateEstadisticas();
			   });
		   }
	   }
 
	   function updateActiveTab(activeTab, ...otherTabs) {
		   if (activeTab) {
			   activeTab.classList.remove('text-amber-600');
			   activeTab.classList.add('text-amber-800', 'border-amber-500');
		   }
		   otherTabs.forEach(tab => {
			   if (tab) {
				   tab.classList.remove('text-amber-800', 'border-amber-500');
				   tab.classList.add('text-amber-600');
			   }
		   });
	   }
 
	   // Render apuestas activas
	   function renderApuestasActivas() {
		   listaApuestas.innerHTML = '';
		   const apuestasActivas = apuestas.filter(a => a.estado === 'activa' || a.estado === 'finalizada');
		   contadorApuestas.textContent = apuestasActivas.length;
		   
		   if (apuestasActivas.length === 0) {
			   listaApuestas.innerHTML = `
				   <div class="col-span-2 p-4 text-center tortilla-card">
					   <p class="text-amber-700">No hay apuestas activas. ¡Crea una nueva!</p>
				   </div>
			   `;
			   return;
		   }
 
		   apuestasActivas.forEach(apuesta => {
			   const participantesHtml = apuesta.participantes.map(p => 
				   `<span class="inline-block bg-amber-100 rounded-full px-3 py-1 text-sm font-semibold text-amber-700 mr-2 mb-2">${p}</span>`
			   ).join('');
 
			   const card = document.createElement('div');
			   card.className = 'p-4 tortilla-card';
			   card.innerHTML = `
				   <div class="flex justify-between items-start">
					   <h3 class="text-lg font-bold text-amber-800">${apuesta.titulo}</h3>
					   <button class="text-white bg-amber-600 hover:bg-amber-700 px-3 py-1 rounded-md text-sm finalizar-btn" data-id="${apuesta.id}" title="Marcar ganador" ${apuesta.estado === 'finalizada' ? 'disabled' : ''}>
						   ${apuesta.estado === 'finalizada' ? '<i class="fas fa-check mr-1"></i>Finalizada' : '<i class="fas fa-trophy mr-1"></i>Finalizar'}
					   </button>
				   </div>
				   <p class="text-amber-700 mt-1">${apuesta.descripcion}</p>
				   <div class="mt-3">
					   ${participantesHtml}
				   </div>
				   <p class="text-sm text-amber-600 mt-2"><i class="far fa-calendar-alt mr-1"></i> ${apuesta.fecha}</p>
				   <div class="mt-3 border-t border-amber-200 pt-2">
					   <p class="text-xs font-semibold text-amber-600 uppercase">Estado</p>
					   ${apuesta.estado === 'finalizada' ? 
						   `<p class="text-sm text-amber-700">🏆 Finalizada - <button onclick="marcarPagada('${apuesta.id}')" class="text-amber-600 hover:text-amber-800 underline">Marcar como pagada</button></p>` :
						   `<p class="text-sm text-amber-700">⏳ Sin resultados</p>`}
				   </div>
			   `;
			   listaApuestas.appendChild(card);
		   });
 
		   // Add event listeners to finalizar buttons
		   document.querySelectorAll('.finalizar-btn').forEach(btn => {
			   btn.addEventListener('click', (e) => {
				   const id = e.currentTarget.getAttribute('data-id');
				   finalizarApuesta(id);
			   });
		   });
	   }
 
	   // Render historial
	   function renderHistorial() {
		   const listaHistorial = document.getElementById('lista-historial');
		   listaHistorial.innerHTML = '';
		   
		   if (historial.length === 0) {
			   listaHistorial.innerHTML = `
				   <div class="col-span-2 p-4 text-center tortilla-card">
					   <p class="text-amber-700">No hay apuestas en el historial</p>
				   </div>
			   `;
			   return;
		   }
 
		   historial.forEach(apuesta => {
			   const participantesHtml = apuesta.participantes.map(p => 
				   `<span class="inline-block bg-amber-100 rounded-full px-3 py-1 text-sm font-semibold text-amber-700 mr-2 mb-2">${p}</span>`
			   ).join('');
 
			   const card = document.createElement('div');
			   card.className = 'p-4 tortilla-card';
			   card.innerHTML = `
				   <div class="flex justify-between items-start">
					   <h3 class="text-lg font-bold text-amber-800">${apuesta.titulo}</h3>
				   </div>
				   <p class="text-amber-700 mt-1">${apuesta.descripcion}</p>
				   <div class="mt-3">
					   ${participantesHtml}
				   </div>
				   <p class="text-sm text-amber-600 mt-2"><i class="far fa-calendar-alt mr-1"></i> ${apuesta.fecha}</p>
				   <div class="mt-3 border-t border-amber-200 pt-2">
					   <p class="text-xs font-semibold text-amber-600 uppercase">Resultado</p>
					   <p class="text-sm font-medium text-green-600">🏆 Ganador: ${apuesta.ganador}</p>
					   <p class="text-sm font-medium text-amber-700">🥚 Tortillas: ${apuesta.tortillas}</p>
					   ${apuesta.resultado ? `<p class="text-sm font-medium text-gray-700">📝 Resultado: ${apuesta.resultado}</p>` : ''}
				   </div>
			   `;
			   listaHistorial.appendChild(card);
		   });
	   }
 
	   // Update estadísticas
	   function updateEstadisticas() {
		   totalApuestas.textContent = historial.length;
		   
		   const totalTortillas = historial.reduce((total, apuesta) => total + (apuesta.tortillas || 0), 0);
		   tortillasPagadas.textContent = totalTortillas;
		   
		   // Calcular rey de la tortilla
		   const ganadores = {};
		   historial.forEach(apuesta => {
			   if (apuesta.ganador) {
				   ganadores[apuesta.ganador] = (ganadores[apuesta.ganador] || 0) + 1;
			   }
		   });
		   
		   let maxGanadas = 0;
		   let rey = '-';
		   for (const [nombre, count] of Object.entries(ganadores)) {
			   if (count > maxGanadas) {
				   maxGanadas = count;
				   rey = nombre;
			   }
		   }
		   
		   reyTortilla.textContent = rey !== '-' ? `${rey} (${maxGanadas})` : rey;
	   }
 

	   // Configuración WhatsApp Modal
	   function initializeWhatsAppModal() {
		   const btnConfig = document.getElementById('btn-whatsapp-config');
		   const modal = document.getElementById('whatsapp-modal');
		   const closeModal = document.getElementById('close-whatsapp-modal');
		   const cancelConfig = document.getElementById('cancel-whatsapp-config');
		   const saveConfig = document.getElementById('save-whatsapp-config');
		   const enabledCheckbox = document.getElementById('whatsapp-enabled');
		   
		   // Elementos de números rápidos
		   const phoneNumbersList = document.getElementById('phone-numbers-list');
		   const newPhoneInput = document.getElementById('new-phone-number');
		   const addPhoneBtn = document.getElementById('add-phone-number');
		   
		   // Elementos de participantes
		   const participantsList = document.getElementById('participants-list');
		   const newParticipantName = document.getElementById('new-participant-name');
		   const newParticipantPhone = document.getElementById('new-participant-phone');
		   const addParticipantBtn = document.getElementById('add-participant');
		   
		   // Tabs del modal
		   const tabQuickNumbers = document.getElementById('tab-quick-numbers');
		   const tabParticipants = document.getElementById('tab-participants');
		   const contentQuickNumbers = document.getElementById('content-quick-numbers');
		   const contentParticipants = document.getElementById('content-participants');

		   // Abrir modal
		   btnConfig.addEventListener('click', async () => {
			   // Verificar PIN antes de abrir modal
			   if (await verifyAdminAccess()) {
				   modal.style.display = 'block';
				   await loadConfigToModal();
			   }
		   });

		   // Cerrar modal
		   [closeModal, cancelConfig].forEach(btn => {
			   btn.addEventListener('click', () => {
				   modal.style.display = 'none';
			   });
		   });

		   // Cerrar modal al hacer click fuera
		   modal.addEventListener('click', (e) => {
			   if (e.target === modal) {
				   modal.style.display = 'none';
			   }
		   });

		   // Tabs del modal
		   tabQuickNumbers.addEventListener('click', () => {
			   switchModalTab('quick-numbers');
		   });
		   
		   tabParticipants.addEventListener('click', () => {
			   switchModalTab('participants');
		   });

		   // Añadir número de teléfono
		   addPhoneBtn.addEventListener('click', addPhoneNumber);
		   newPhoneInput.addEventListener('keypress', (e) => {
			   if (e.key === 'Enter') {
				   addPhoneNumber();
			   }
		   });

		   // Añadir participante
		   addParticipantBtn.addEventListener('click', addParticipantWithPhone);
		   [newParticipantName, newParticipantPhone].forEach(input => {
			   input.addEventListener('keypress', (e) => {
				   if (e.key === 'Enter') {
					   addParticipantWithPhone();
				   }
			   });
		   });

		   // Cambiar PIN
		   const changePinBtn = document.getElementById('change-pin-btn');
		   changePinBtn.addEventListener('click', changeAdminPin);

		   // Guardar configuración
		   saveConfig.addEventListener('click', async () => {
			   whatsappConfig.enabled = enabledCheckbox.checked;
			   const saved = await saveWhatsAppConfig();
			   updateWhatsAppUI();
			   modal.style.display = 'none';
			   
			   if (saved && whatsappConfig.enabled && whatsappConfig.phoneNumbers.length > 0) {
				   alert('✅ Configuración WhatsApp guardada en Firebase correctamente');
			   } else if (saved) {
				   alert('✅ Configuración guardada correctamente');
			   } else {
				   alert('⚠️ Error guardando en Firebase, pero se guardó localmente');
			   }
		   });
	   }

	   // Cambiar pestaña del modal
	   function switchModalTab(tab) {
		   const tabQuickNumbers = document.getElementById('tab-quick-numbers');
		   const tabParticipants = document.getElementById('tab-participants');
		   const contentQuickNumbers = document.getElementById('content-quick-numbers');
		   const contentParticipants = document.getElementById('content-participants');

		   if (tab === 'quick-numbers') {
			   tabQuickNumbers.classList.add('text-green-600', 'border-b-2', 'border-green-500');
			   tabQuickNumbers.classList.remove('text-gray-500');
			   tabParticipants.classList.add('text-gray-500');
			   tabParticipants.classList.remove('text-green-600', 'border-b-2', 'border-green-500');
			   
			   contentQuickNumbers.classList.remove('hidden');
			   contentParticipants.classList.add('hidden');
		   } else {
			   tabParticipants.classList.add('text-green-600', 'border-b-2', 'border-green-500');
			   tabParticipants.classList.remove('text-gray-500');
			   tabQuickNumbers.classList.add('text-gray-500');
			   tabQuickNumbers.classList.remove('text-green-600', 'border-b-2', 'border-green-500');
			   
			   contentParticipants.classList.remove('hidden');
			   contentQuickNumbers.classList.add('hidden');
		   }
	   }

	   async function loadConfigToModal() {
		   document.getElementById('whatsapp-enabled').checked = whatsappConfig.enabled;
		   renderPhoneNumbersList();
		   await renderParticipantsList();
	   }

	   function renderPhoneNumbersList() {
		   const phoneNumbersList = document.getElementById('phone-numbers-list');
		   phoneNumbersList.innerHTML = '';

		   if (whatsappConfig.phoneNumbers.length === 0) {
			   phoneNumbersList.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No hay números configurados</p>';
			   return;
		   }

		   whatsappConfig.phoneNumbers.forEach((number, index) => {
			   const div = document.createElement('div');
			   div.className = 'flex items-center justify-between bg-gray-50 p-2 rounded';
			   div.innerHTML = `
				   <span class="text-sm">${number}</span>
				   <button type="button" class="text-red-500 hover:text-red-700" onclick="removePhoneNumber(${index})">
					   <i class="fas fa-times"></i>
				   </button>
			   `;
			   phoneNumbersList.appendChild(div);
		   });
	   }

		   async function renderParticipantsList() {
			   const participantsList = document.getElementById('participants-list');
			   participantsList.innerHTML = '';

			   try {
				   const participants = await loadParticipants();
				   
				   if (participants.length === 0) {
					   participantsList.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No hay participantes registrados</p>';
					   return;
				   }

				   participants.forEach((participant) => {
					   const div = document.createElement('div');
					   div.className = 'flex items-center justify-between bg-blue-50 p-2 rounded';
					   
					   const hasPhone = participant.phoneNumber && participant.phoneNumber.trim() !== '';
					   const phoneDisplay = hasPhone ? '📱' : '❌';
					   const phoneTitle = hasPhone ? 'Tiene número configurado' : 'Sin número de teléfono';
					   
					   div.innerHTML = `
						   <div class="flex-1">
							   <span class="text-sm font-medium">${participant.name}</span>
							   <span class="text-xs text-gray-500 block">
								   <span title="${phoneTitle}">${phoneDisplay}</span>
								   ${hasPhone ? 'Disponible para notificaciones' : 'Sin WhatsApp configurado'}
							   </span>
						   </div>
						   <div class="flex space-x-1">
							   ${hasPhone ? `
								   <button type="button" class="text-green-500 hover:text-green-700 text-xs" onclick="addParticipantNumberToConfig('${participant.phoneNumber}')" title="Añadir a notificaciones">
									   <i class="fas fa-bell"></i>
								   </button>
							   ` : ''}
							   <button type="button" class="text-blue-500 hover:text-blue-700 text-xs" onclick="editParticipant('${participant.id}', '${participant.name}', '${participant.phoneNumber || ''}')" title="Editar participante">
								   <i class="fas fa-edit"></i>
							   </button>
							   <button type="button" class="text-red-500 hover:text-red-700 text-xs" onclick="removeParticipant('${participant.id}')" title="Eliminar participante">
								   <i class="fas fa-trash"></i>
							   </button>
						   </div>
					   `;
					   participantsList.appendChild(div);
				   });
			   } catch (error) {
				   console.error('Error renderizando participantes:', error);
				   participantsList.innerHTML = '<p class="text-sm text-red-500 text-center py-4">Error cargando participantes</p>';
			   }
		   }

	   function addPhoneNumber() {
		   const input = document.getElementById('new-phone-number');
		   const number = input.value.trim();

		   if (!number) {
			   alert('Por favor, introduce un número de teléfono');
			   return;
		   }

		   // Validar formato básico
		   if (!/^\+\d{10,15}$/.test(number)) {
			   alert('Formato incorrecto. Usa: +34XXXXXXXXX');
			   return;
		   }

		   if (whatsappConfig.phoneNumbers.includes(number)) {
			   alert('Este número ya está en la lista');
			   return;
		   }

		   whatsappConfig.phoneNumbers.push(number);
		   input.value = '';
		   renderPhoneNumbersList();
	   }

	   function removePhoneNumber(index) {
		   whatsappConfig.phoneNumbers.splice(index, 1);
		   renderPhoneNumbersList();
	   }

	   async function addParticipantWithPhone() {
		   const nameInput = document.getElementById('new-participant-name');
		   const phoneInput = document.getElementById('new-participant-phone');
		   
		   const name = nameInput.value.trim();
		   const phone = phoneInput.value.trim();

		   if (!name) {
			   alert('Por favor, introduce el nombre del participante');
			   return;
		   }

		   // Validar formato solo si se proporciona teléfono
		   if (phone && !/^\+\d{10,15}$/.test(phone)) {
			   alert('Formato de teléfono incorrecto. Usa: +34XXXXXXXXX o déjalo vacío');
			   return;
		   }

		   const saved = await saveParticipant(name, phone);
		   
		   if (saved) {
			   nameInput.value = '';
			   phoneInput.value = '';
			   await renderParticipantsList();
			   const phoneMsg = phone ? ' con número de WhatsApp' : ' sin número de teléfono';
			   alert(`✅ Participante ${name} añadido correctamente${phoneMsg}`);
		   } else {
			   alert('❌ Error guardando el participante');
		   }
	   }

	   async function editParticipant(id, currentName, currentPhone) {
		   const newName = prompt('Nombre del participante:', currentName);
		   if (!newName || newName.trim() === '') {
			   return;
		   }

		   const newPhone = prompt('Número de teléfono (opcional, formato +34XXXXXXXXX):', currentPhone || '');
		   
		   // Validar formato solo si se proporciona teléfono
		   if (newPhone && newPhone.trim() !== '' && !/^\+\d{10,15}$/.test(newPhone.trim())) {
			   alert('Formato de teléfono incorrecto. Usa: +34XXXXXXXXX o déjalo vacío');
			   return;
		   }

		   try {
			   const updateData = {
				   name: newName.trim(),
				   phoneNumber: newPhone ? newPhone.trim() : '',
				   updatedAt: new Date().toISOString()
			   };

			   await window.firestore.updateDoc(window.firestore.doc(window.db, 'participants', id), updateData);
			   await renderParticipantsList();
			   alert(`✅ Participante ${newName} actualizado correctamente`);
		   } catch (error) {
			   console.error('Error actualizando participante:', error);
			   alert('❌ Error actualizando el participante');
		   }
	   }

	   function addParticipantNumberToConfig(phoneNumber) {
		   if (!whatsappConfig.phoneNumbers.includes(phoneNumber)) {
			   whatsappConfig.phoneNumbers.push(phoneNumber);
			   renderPhoneNumbersList();
			   alert('✅ Número añadido a las notificaciones');
		   } else {
			   alert('ℹ️ Este número ya está en la lista de notificaciones');
		   }
	   }

	   async function removeParticipant(participantId) {
		   if (confirm('¿Estás seguro de que quieres eliminar este participante?')) {
			   try {
				   await window.firestore.deleteDoc(window.firestore.doc(window.db, 'participants', participantId));
				   await renderParticipantsList();
				   alert('✅ Participante eliminado correctamente');
			   } catch (error) {
				   console.error('Error eliminando participante:', error);
				   alert('❌ Error eliminando el participante');
			   }
		   }
	   }

	   // Funciones de seguridad con PIN
	   async function verifyAdminAccess() {
		   // Si no hay PIN configurado, configurar uno la primera vez
		   if (!whatsappConfig.adminPin) {
			   return await setupAdminPin();
		   }
		   
		   // Verificar PIN existente
		   const inputPin = prompt('🔒 Introduce el PIN de administrador para acceder a la configuración:');
		   if (!inputPin) {
			   return false; // Usuario canceló
		   }
		   
		   if (inputPin === whatsappConfig.adminPin) {
			   return true;
		   } else {
			   alert('❌ PIN incorrecto. Acceso denegado.');
			   return false;
		   }
	   }

	   async function setupAdminPin() {
		   const newPin = prompt('🔐 Configura un PIN de administrador (4-6 dígitos) para proteger la gestión de contactos:');
		   
		   if (!newPin) {
			   alert('⚠️ Se requiere un PIN para acceder a la configuración.');
			   return false;
		   }
		   
		   // Validar PIN
		   if (!/^\d{4,6}$/.test(newPin)) {
			   alert('❌ El PIN debe tener entre 4 y 6 dígitos.');
			   return await setupAdminPin(); // Reintentar
		   }
		   
		   // Confirmar PIN
		   const confirmPin = prompt('🔐 Confirma el PIN:');
		   if (newPin !== confirmPin) {
			   alert('❌ Los PINs no coinciden. Inténtalo de nuevo.');
			   return await setupAdminPin(); // Reintentar
		   }
		   
		   // Guardar PIN
		   whatsappConfig.adminPin = newPin;
		   const saved = await saveWhatsAppConfig();
		   
		   if (saved) {
			   alert('✅ PIN de administrador configurado correctamente.\n\n⚠️ IMPORTANTE: Recuerda este PIN, lo necesitarás para gestionar contactos.');
			   return true;
		   } else {
			   alert('❌ Error guardando el PIN. Inténtalo de nuevo.');
			   return false;
		   }
	   }

	   async function changeAdminPin() {
		   // Verificar PIN actual
		   const currentPin = prompt('🔒 Introduce el PIN actual:');
		   if (!currentPin || currentPin !== whatsappConfig.adminPin) {
			   alert('❌ PIN actual incorrecto.');
			   return;
		   }
		   
		   // Configurar nuevo PIN
		   const newPin = prompt('🔐 Introduce el nuevo PIN (4-6 dígitos):');
		   if (!newPin || !/^\d{4,6}$/.test(newPin)) {
			   alert('❌ El PIN debe tener entre 4 y 6 dígitos.');
			   return;
		   }
		   
		   // Confirmar nuevo PIN
		   const confirmPin = prompt('🔐 Confirma el nuevo PIN:');
		   if (newPin !== confirmPin) {
			   alert('❌ Los PINs no coinciden.');
			   return;
		   }
		   
		   // Guardar nuevo PIN
		   whatsappConfig.adminPin = newPin;
		   const saved = await saveWhatsAppConfig();
		   
		   if (saved) {
			   alert('✅ PIN cambiado correctamente.');
		   } else {
			   alert('❌ Error guardando el nuevo PIN.');
		   }
	   }
	   
	   
	   // Event listeners para formulario
	   if (formNuevaApuesta) {
		   formNuevaApuesta.addEventListener('submit', async function(e) {
			   e.preventDefault();
			   
			   const titulo = document.getElementById('titulo').value;
			   const descripcion = document.getElementById('descripcion').value;
			   
			   const participantes = Array.from(document.querySelectorAll('#lista-participantes input[type="checkbox"]:checked'))
				   .map(el => el.value);
			   
			   if (participantes.length < 2) {
				   alert('¡Necesitas al menos 2 participantes para una apuesta!');
				   return;
			   }
			   
			   const nuevaApuesta = {
				   titulo,
				   descripcion,
				   participantes,
				   fecha: new Date().toISOString().split('T')[0],
				   estado: 'activa',
				   ganador: null,
				   resultado: ""
			   };
			   
			   // Guardar en Firebase
			   const guardado = await guardarApuestaFirebase(nuevaApuesta);
			   
			   if (guardado) {
				   // Recargar datos desde Firebase
				   await cargarDatosFirebase();
				   
				   // Enviar notificación WhatsApp
				   notifyNewBet(nuevaApuesta);
				   
				   // Reset form y recargar participantes
				   formNuevaApuesta.reset();
				   await renderParticipantesFormulario();
				   
				   // Switch to active bets tab and update
				   if (tabActivas) {
					   tabActivas.click();
				   }
				   
				   alert('¡Nueva apuesta creada y guardada! 🎉');
			   } else {
				   alert('Error guardando la apuesta. Inténtalo de nuevo.');
			   }
		   });
	   }

	   // Marcar como pagada
	   async function marcarPagada(id) {
		   const apuesta = apuestas.find(a => a.id === id);
		   if (!apuesta) return;
		   
		   if (confirm(`¿Confirmas que la apuesta "${apuesta.titulo}" ha sido pagada?`)) {
			   // Eliminar de Firebase
			   const eliminado = await eliminarApuestaFirebase(id);
			   
			   if (eliminado) {
				   // Recargar datos
				   await cargarDatosFirebase();
				   alert('¡Apuesta marcada como pagada! 💰');
			   } else {
				   alert('Error eliminando la apuesta. Inténtalo de nuevo.');
			   }
		   }
	   }

	   // Finalizar apuesta
	   async function finalizarApuesta(id) {
		   const apuesta = apuestas.find(a => a.id === id);
		   if (!apuesta) return;
		   
		   const ganador = prompt(`Introduce el ganador de "${apuesta.titulo}":`, apuesta.participantes[0]);
		   if (!ganador || !apuesta.participantes.includes(ganador)) {
			   alert('Por favor, introduce un participante válido');
			   return;
		   }
		   
		   const resultado = prompt(`Introduce el resultado de "${apuesta.titulo}":`, "Detalles del resultado");
		   const tortillas = parseInt(prompt('¿Cuántas tortillas se deben?', '1')) || 1;
		   
		   // Crear objeto para historial
		   const apuestaFinalizada = {
			   titulo: apuesta.titulo,
			   descripcion: apuesta.descripcion,
			   participantes: apuesta.participantes,
			   fecha: apuesta.fecha,
			   estado: 'finalizada',
			   ganador: ganador,
			   tortillas: tortillas,
			   resultado: resultado || ""
		   };
		   
		   // Guardar en historial Firebase
		   const guardadoHistorial = await guardarHistorialFirebase(apuestaFinalizada);
		   
		   // Actualizar estado en apuestas Firebase
		   const actualizado = await actualizarApuestaFirebase(id, {
			   estado: 'finalizada',
			   ganador: ganador,
			   tortillas: tortillas,
			   resultado: resultado || ""
		   });
		   
		   if (guardadoHistorial && actualizado) {
			   // Recargar datos
			   await cargarDatosFirebase();
			   
			   // Enviar notificación WhatsApp
			   notifyFinishedBet(apuestaFinalizada);
			   
			   // Notificación mejorada
			   const mensaje = `${ganador} ganó '${apuesta.titulo}'!\n\n🏆 Premio: ${tortillas} tortilla(s)!\n📅 Fecha tope: ${new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toLocaleDateString()}\n📍 Lugar: Quedada en casa del perdedor`;
			   
			   alert(mensaje);
		   } else {
			   alert('Error finalizando la apuesta. Inténtalo de nuevo.');
		   }
	   }

	   // Renderizar participantes en el formulario de nueva apuesta
	   async function renderParticipantesFormulario() {
		   const listaParticipantes = document.getElementById('lista-participantes');
		   if (!listaParticipantes) return;

		   try {
			   const participants = await loadParticipants();
			   listaParticipantes.innerHTML = '';
			   
			   if (participants.length === 0) {
				   listaParticipantes.innerHTML = `
					   <div class="text-center py-4 text-amber-600">
						   <i class="fas fa-users mb-2 text-2xl"></i>
						   <p class="text-sm">No hay participantes registrados</p>
						   <p class="text-xs">Añade participantes desde el botón de WhatsApp</p>
					   </div>
				   `;
				   return;
			   }

			   participants.forEach((participant, index) => {
				   const participantId = `participant-${participant.id}`;
				   const hasPhone = participant.phoneNumber && participant.phoneNumber.trim() !== '';
				   
				   const div = document.createElement('div');
				   div.className = 'flex items-center justify-between';
				   div.innerHTML = `
					   <div class="flex items-center">
						   <input type="checkbox" id="${participantId}" value="${participant.name}" class="h-4 w-4 rounded border-amber-300 text-amber-600 focus:ring-amber-500">
						   <label for="${participantId}" class="ml-2 block text-sm text-amber-700">
							   ${participant.name}
							   ${hasPhone ? '<i class="fas fa-mobile-alt ml-1 text-green-500" title="Tiene WhatsApp configurado"></i>' : ''}
						   </label>
					   </div>
				   `;
				   listaParticipantes.appendChild(div);
			   });
		   } catch (error) {
			   console.error('Error cargando participantes para formulario:', error);
			   listaParticipantes.innerHTML = `
				   <div class="text-center py-4 text-red-600">
					   <p class="text-sm">Error cargando participantes</p>
				   </div>
			   `;
		   }
	   }

	   // Initialize
	   document.addEventListener('DOMContentLoaded', async () => {
		   console.log('DOM cargado, inicializando aplicación...');
		   
		   initializeTabs();
		   initializeWhatsAppModal();
		   
		   // Cargar datos en paralelo
		   await Promise.all([
			   loadWhatsAppConfig(),
			   cargarDatosFirebase()
		   ]);
		   
		   // Cargar participantes en el formulario
		   await renderParticipantesFormulario();
		   
		   console.log('Aplicación inicializada completamente');
	   });
   </script>
</body>
</html>
